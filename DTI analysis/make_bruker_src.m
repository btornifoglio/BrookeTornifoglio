num_dif = 74;
dimension = [128 128 24]; % [x y z] the dimension of the 2dseq file, suppose average=1
voxel_size = [0.234 0.234 0.234]; % [x y z] pixel spacing in mm
f1 = fopen('2dseq','r');
A=fread(f1,'int16');
A=reshape(A,dimension(1),dimension(2),dimension(3),num_dif);
%%
% slope is a dimension(3) x num_dif matrix that defines the scaling parameters 
% input the slope here
% slope=[0.01237757286 0.01237757286 0.01237757286 0.01237757286
% ...
% ]
% slope = slope./min(min(slope));
% slope = reshape(slope',dimension(3),num_dif);
% for i = 1:dimension(3)
% for j = 1:num_dif
%     A(:,:,i,j) = A(:,:,i,j)/slope(i,j);
% end
% end

% image0 ~ imageN, where N is the number of diffusion gradient encoding
for loopID=1:num_dif
    image(:,loopID) = reshape(A(:,:,:,loopID),prod(dimension),1);
end

%%
% if averaging on the repeat images is needed, run
repeat = 3;
dimension(3) = dimension(3)/repeat; 
for loopID2 = 1:num_dif
    image(:,:,:,loopID2) = reshape(sum(reshape(image(:,loopID2),dimension(1),dimension(2),dimension(3),repeat),4),prod(dimension),1)/repeat;
end

%%
% the b-table should be arranged in the format of [b-value1 bx by bz; b-value2 bx by bz;...;b-valueN bx by bz] 
b_table=[  0.00000000	  0.00000000	  0.00000000	  0.00000000	  0.00000000	  0.00000000
436.91455519	746.10604717	-306.61265154	318.52580041	-261.79667252	 53.79273645
273.15896348	724.87240430	245.78405835	480.89214776	326.11428716	 55.28813934
 73.06535796	-447.93434531	-121.76618807	686.52636251	373.24978113	 50.73199178
565.97906352	617.54230273	415.53243106	168.45079626	226.69465257	 76.26925287
 82.95669013	464.70352420	-159.84122793	650.78948141	-447.69615214	 76.99565311
535.84131180	-633.70369058	434.75986693	187.35974560	-257.08071226	 88.18662248
277.09400097	-702.51443367	-314.20595625	445.26995152	398.30205388	 89.07210423
575.82786811	493.72397337	-551.22099786	105.83169701	-236.31282571	131.91641344
481.68318207	-620.41355758	-504.55388077	199.77497490	324.93564215	132.12762459
 95.59833926	-508.41603169	127.27904639	675.97110812	-338.45100337	 42.36463671
223.35729481	612.81957000	-391.49988356	420.34425795	-537.07399730	171.55490596
171.98618760	-567.44608067	347.33674515	468.05365443	-572.99623145	175.36701089
357.91432044	-776.48189842	230.48043298	421.13719971	-250.00939321	 37.10471121
 85.74725134	428.54446274	258.59648087	535.44094320	646.20199612	194.96875664
330.87608565	607.79423721	522.89701104	279.11796198	480.26104597	206.58888328
703.04549404	-472.77283739	-312.17023594	 79.48068712	104.96163438	 34.65289837
 71.26536644	-384.93105811	-253.94347368	519.78936932	685.82212449	226.22239613
325.59988025	-532.30643960	599.27087577	217.56008127	-489.85851284	275.74148850
 86.00413176	492.71909865	 98.39543740	705.69897401	281.85454718	 28.14301448
340.58428692	477.20336221	-652.23482698	167.15616196	-456.93337059	312.26504412
228.28953970	-498.42686082	-540.46677128	272.05510151	590.00328386	319.88361276
395.09788758	-335.02053391	-749.13218906	 71.01958886	317.61074134	355.10126372
528.79923264	-310.25665392	723.16146565	 45.50838265	-212.14635227	247.24057503
322.34997949	352.69998379	721.46113507	 96.47687799	394.69419394	403.68093883
126.63327476	382.04162148	454.51286035	288.14662026	685.61296577	407.83502719
113.15141230	359.54613876	-438.20236870	285.62044272	-696.20858663	424.25744415
104.77339261	-337.57740172	432.77301170	271.91660810	-697.19222210	446.89895732
244.15870399	-250.52148062	710.44586760	 64.26251780	-364.48004462	516.80866025
593.37675780	271.59268502	691.42700379	 31.07746705	158.23548360	201.41979580
139.25777344	-227.82539294	-575.45419024	 93.18045303	470.72085732	594.48660724
719.24595904	-535.59052460	154.75440095	 99.70761964	-57.61936494	  8.32431671
755.80533185	160.90254396	-437.93144856	  8.56359024	-46.61536588	 63.43695445
704.88535042	576.59184932	-123.24800725	117.91214008	-50.40805315	  5.38742622
 64.32015674	164.03693027	411.87048876	104.58663293	525.20060638	659.34734970
235.79709983	744.31999966	-69.28959384	587.38239601	-109.36018827	  5.09023204
515.95264948	-797.30576589	-96.02516013	308.02074810	 74.19422492	  4.46786706
220.56223441	207.77918987	-702.25183815	 48.93425189	-330.77584294	558.97788385
494.53367575	810.32769146	 69.55562493	331.94451650	 56.98585530	  2.44573079
229.51743559	-741.32834347	-30.11883596	598.61216144	 48.64106884	  0.98809953
 42.96201955	-226.49509508	-289.54028501	298.51964966	763.22592692	487.83540395
737.44180695	-135.83949545	504.26734667	  6.25553378	-46.44395076	 86.20529597
771.79081203	322.70501077	274.80828789	 33.73275580	 57.45210368	 24.46245599
 50.71974119	147.81471331	-369.15348637	107.69568691	-537.91990528	671.70244417
  0.46951220	 37.64805497	 11.88776410	754.70671118	476.61295389	 75.24774341
 24.40907143	228.86840379	-162.34691263	536.48851829	-761.11209030	269.94595143
637.79761038	-199.95696563	-672.79786868	 15.67220834	105.46497675	177.42970683
  1.01730280	-54.74528667	 19.55421067	736.51778383	-526.14662509	 93.96591541
 22.00051968	-214.09503354	159.61852285	520.85909855	-776.65285877	289.51671609
502.46618353	150.84694037	-806.30631067	 11.32155763	-121.03186637	323.46946319
  0.36146880	 28.25982863	 20.34174667	552.34222298	795.16445226	286.18421688
 23.42055141	-114.35256658	252.05522445	139.58370635	-615.33909532	678.16332603
 22.26875198	269.68892294	-16.80547935	816.52662014	-101.76258709	  3.17063274
422.01189276	  7.09649223	842.30667587	  0.02983340	  7.08205490	420.29652978
 16.59384214	-234.34238513	  0.52616613	827.36042990	 -3.71532478	  0.00417099
  6.29846775	 86.39261228	116.82550167	296.24996726	801.21552369	541.72690831
187.06369261	 91.68260201	695.58221828	 11.23373996	170.45741693	646.61749114
  1.18437051	 38.46294158	-50.19056324	312.27514194	-814.98006216	531.73661022
 81.97216853	-71.15488443	495.24317640	 15.44127009	-214.94472826	748.01547941
275.88144996	-54.89835178	-791.09697240	  2.73109068	 78.71119985	567.12259907
  8.66605051	-57.61465734	-160.50560182	 95.76013712	533.54612001	743.18884334
846.61679782	-82.18961967	-27.88550950	  1.99474355	  1.35356363	  0.22962031
 65.98786158	-13.55556428	-454.76537693	  0.69616335	 46.71011569	783.52117755
  1.02455740	 10.20150152	-58.55978292	 25.39404655	-291.53940727	836.76331195
  8.06447982	 18.60018238	165.40197426	 10.72501862	190.74428591	848.09602456

]';% [b_value bx by bz; b_value bx by bz; ...]
b_table(4,:) = -b_table(4,:);    % note that the z-dimension should be flipped for images from bruker 
fclose(f1);
clear A;
clear ans;
clear f1;
save '1.src' '-v4'